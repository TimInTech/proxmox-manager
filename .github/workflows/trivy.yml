name: "Vulnerability Scan (Trivy)"

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  trivy-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare Trivy result directory
        run: mkdir -p trivy-results

      - name: Run Trivy filesystem scan
        uses: aquasecurity/trivy-action@v0.14.0
        with:
          scan-type: fs
          scan-ref: .
          ignore-unfixed: true
          vuln-type: "os,library"
          security-checks: "vuln,secret,config"
          severity: "CRITICAL,HIGH,MEDIUM"
          format: "sarif"
          output: "trivy-results/fs.sarif"

      - name: Run Trivy Node dependency scan
        if: ${{ hashFiles('**/package-lock.json', '**/pnpm-lock.yaml', '**/yarn.lock') != '' }}
        uses: aquasecurity/trivy-action@v0.14.0
        with:
          scan-type: fs
          scan-ref: .
          ignore-unfixed: true
          vuln-type: "library"
          security-checks: "vuln"
          severity: "CRITICAL,HIGH,MEDIUM"
          format: "sarif"
          output: "trivy-results/node-deps.sarif"
          args: "--dependency-tree"

      - name: Run Trivy Python dependency scan
        if: ${{ hashFiles('**/requirements.txt', '**/requirements/*.txt', '**/poetry.lock', '**/Pipfile.lock') != '' }}
        uses: aquasecurity/trivy-action@v0.14.0
        with:
          scan-type: fs
          scan-ref: .
          ignore-unfixed: true
          vuln-type: "library"
          security-checks: "vuln"
          severity: "CRITICAL,HIGH,MEDIUM"
          format: "sarif"
          output: "trivy-results/python-deps.sarif"
          args: "--dependency-tree"

      - name: Build container image for scan
        if: ${{ hashFiles('**/Dockerfile') != '' }}
        run: docker build -t proxmox-manager:${{ github.sha }} .

      - name: Run Trivy container image scan
        if: ${{ hashFiles('**/Dockerfile') != '' }}
        uses: aquasecurity/trivy-action@v0.14.0
        with:
          scan-type: image
          image-ref: proxmox-manager:${{ github.sha }}
          ignore-unfixed: true
          severity: "CRITICAL,HIGH,MEDIUM"
          format: "sarif"
          output: "trivy-results/image.sarif"
          security-checks: "vuln"

      - name: Upload filesystem SARIF to Code Scanning
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-results/fs.sarif

      - name: Upload Node dependency SARIF
        if: ${{ hashFiles('**/package-lock.json', '**/pnpm-lock.yaml', '**/yarn.lock') != '' }}
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-results/node-deps.sarif

      - name: Upload Python dependency SARIF
        if: ${{ hashFiles('**/requirements.txt', '**/requirements/*.txt', '**/poetry.lock', '**/Pipfile.lock') != '' }}
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-results/python-deps.sarif

      - name: Upload container image SARIF
        if: ${{ hashFiles('**/Dockerfile') != '' }}
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-results/image.sarif

      - name: Archive Trivy results
        uses: actions/upload-artifact@v4
        with:
          name: trivy-scan-sarif
          path: trivy-results
